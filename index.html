<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Himalaya: Echoes of Eternity</title>
    <style>
        :root { --gold: #FFD700; --neon-blue: #00f2ff; --blood: #ff0000; --dark: #0a0a0a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }

        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ø£Ø³ÙˆØ§Ù‚ */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); color: white; }
        .royal-card { background: linear-gradient(145deg, #181818, #000); border: 2px solid var(--gold); border-radius: 30px; padding: 30px; width: 90%; max-width: 550px; text-align: center; box-shadow: 0 0 70px rgba(255,215,0,0.15); }
        
        .market-scroller { display: flex; gap: 15px; overflow-x: auto; padding: 15px 5px; scrollbar-width: none; }
        .cat-item { min-width: 120px; background: #222; padding: 15px; border-radius: 20px; border: 1px solid #444; transition: 0.3s; cursor: pointer; }
        .cat-item.active { border-color: var(--gold); background: #333; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.5); }
        .cat-item img { width: 70px; height: 70px; margin-bottom: 10px; }
        
        .btn-play { background: var(--gold); color: #000; width: 100%; padding: 20px; border-radius: 50px; border: none; font-size: 26px; font-weight: bold; cursor: pointer; margin-top: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
        
        /* HUD - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        #hud { position: fixed; top: 15px; width: 100%; padding: 10px 25px; z-index: 1000; display: flex; justify-content: space-between; color: white; font-weight: bold; text-shadow: 2px 2px 5px #000; }
        .stat { background: rgba(0,0,0,0.7); padding: 8px 18px; border-radius: 25px; border: 1px solid var(--gold); }
        .life-icon { color: var(--blood); margin-left: 5px; font-size: 20px; }

        #flash { position: fixed; inset: 0; background: var(--blood); opacity: 0; pointer-events: none; z-index: 2500; transition: opacity 0.1s; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="flash"></div>

<div id="hud" style="display:none;">
    <div class="stat">ğŸ’° $<span id="balance">500</span></div>
    <div class="stat" style="border-color:red">â¤ï¸ <span id="lives"></span></div>
    <div class="stat">ğŸ† <span id="score">0</span></div>
</div>

<div id="overlay">
    <div class="royal-card">
        <h1 style="color:var(--gold); margin:0; font-size:36px;">Ù‚Ø§Ø¹Ø© Ø£Ø³Ø§Ø·ÙŠØ± Ø§Ù„Ù‡ÙŠÙ…Ø§Ù„Ø§ÙŠØ§</h1>
        <p style="color:#bbb; font-size:16px;">Ø§Ø®ØªØ± Ù‚Ø·ØªÙƒ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙˆØ±Ø§Ù‡Ù† Ù„ØªØºØ²Ùˆ Ø§Ù„Ø¹Ø±Ø´</p>

        <div class="market-scroller">
            <div class="cat-item active" data-type="1" data-price="0" data-lives="3" onclick="selectCat(this)">
                <img src="https://cdn-icons-png.flaticon.com/512/1864/1864514.png">
                <div>Ø§Ù„Ø¹Ø§Ø¯ÙŠ</div><small>3 Ø£Ø±ÙˆØ§Ø­ | Ù…Ø¬Ø§Ù†ÙŠ</small>
            </div>
            <div class="cat-item" data-type="2" data-price="100" data-lives="5" onclick="selectCat(this)">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png">
                <div>Ø§Ù„Ù…Ù„ÙƒÙŠ</div><small>5 Ø£Ø±ÙˆØ§Ø­ | 100$</small>
            </div>
            <div class="cat-item" data-type="3" data-price="500" data-lives="9" onclick="selectCat(this)">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616430.png">
                <div>Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ</div><small>9 Ø£Ø±ÙˆØ§Ø­ | 500$</small>
            </div>
        </div>

        <div style="background:rgba(255,215,0,0.1); padding:20px; border-radius:15px; margin-top:20px;">
            <div id="palace-info" style="font-size:18px;"><b>Ù‚ØµØ± Ø§Ù„ØºØ¨Ø§Ø± (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1)</b><br>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„: 10$ | Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: 50$</div>
        </div>

        <button class="btn-play" onclick="startRoyalGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚ØµØ± ğŸ¾</button>
    </div>
</div>

<script>
const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
document.body.appendChild(canvas);

// Game Assets (Images and Sounds)
const assets = {
    cat: new Image(), coin: new Image(), monster1: new Image(), monster2: new Image(), shield: new Image(), heart: new Image(), magnet: new Image(),
    sfx: {
        jump: new Audio('https://www.soundjay.com/buttons/sounds/button-2.mp3'),
        collect: new Audio('https://www.soundjay.com/button/sounds/button-3.mp3'),
        hit: new Audio('https://www.soundjay.com/misc/sounds/ding-4.mp3'),
        lose: new Audio('https://www.soundjay.com/misc/sounds/error-2.mp3'),
        win: new Audio('https://www.soundjay.com/buttons/sounds/button-7.mp3')
    }
};
assets.cat.src = 'https://cdn-icons-png.flaticon.com/512/616/616408.png';
assets.coin.src = 'https://cdn-icons-png.flaticon.com/512/2489/2489756.png';
assets.monster1.src = 'https://cdn-icons-png.flaticon.com/512/1211/1211053.png'; // Basic monster
assets.monster2.src = 'https://cdn-icons-png.flaticon.com/512/865/865761.png'; // Shadow monster (more menacing)
assets.shield.src = 'https://cdn-icons-png.flaticon.com/512/2807/2807494.png';
assets.heart.src = 'https://cdn-icons-png.flaticon.com/512/2107/2107845.png';
assets.magnet.src = 'https://cdn-icons-png.flaticon.com/512/1000/1000732.png';

// Game Configuration and State
let config = {
    balance: 1000,
    currentCat: { type: 1, price: 0, lives: 3 },
    unlockedLevels: 1
};
let game = {
    playing: false, score: 0, lives: 0, dist: 0, frame: 0, level: 1,
    isShielded: false, magnetActive: false, magnetTimer: 0
};
let player = { x: 0, y: 0, v: 0, g: 0.5, j: -10, w: 85, h: 80, initialY: 0 };
let world = { obs: [], items: [], particles: [] };

// Utility Functions
function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    player.x = canvas.width * 0.15;
    player.initialY = canvas.height / 2;
    player.y = player.initialY;
}
window.onresize = resize; resize();

function playSFX(sound) {
    if (assets.sfx[sound]) {
        assets.sfx[sound].currentTime = 0;
        assets.sfx[sound].volume = 0.5; // Adjust volume
        assets.sfx[sound].play().catch(e => console.error("Audio play failed:", e));
    }
}

function updateHUD() {
    document.getElementById('balance').innerText = config.balance;
    let livesHTML = '';
    for (let i = 0; i < game.lives; i++) {
        livesHTML += '<span class="life-icon">â¤ï¸</span>';
    }
    document.getElementById('lives').innerHTML = livesHTML;
    document.getElementById('score').innerText = game.score;
}

// Particle Effects
function createParticles(x, y, color, count = 10) {
    for (let i = 0; i < count; i++) {
        world.particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8,
            life: 30 + Math.random() * 30, // frames
            color: color,
            radius: 3 + Math.random() * 3
        });
    }
}

// Game Logic
function selectCat(el) {
    const type = parseInt(el.dataset.type);
    const price = parseInt(el.dataset.price);
    const lives = parseInt(el.dataset.lives);

    if (config.balance < price) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø·Ø©!");
    
    document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    config.currentCat = { type, price, lives };
    playSFX('collect'); // Selection sound
}

function startRoyalGame() {
    let fee = 10 * game.level;
    if (config.balance < fee) return alert("Ù„Ø§ ØªÙ…Ù„Ùƒ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚ØµØ±!");
    
    config.balance -= fee;
    game.playing = true; game.score = 0; game.dist = 0; game.frame = 0;
    game.lives = config.currentCat.lives; // Set lives based on selected cat
    game.isShielded = false;
    game.magnetActive = false;
    world = { obs: [], items: [], particles: [] };
    player.y = player.initialY;

    document.getElementById('overlay').style.display = 'none';
    document.getElementById('hud').style.display = 'flex';
    updateHUD();
    playSFX('win'); // Game start sound
    loop();
}

function loop() {
    if (!game.playing) return;
    game.frame++;
    game.dist += (4 + game.level * 0.5); // Speed increases with level

    // Apply gravity to player
    player.v += player.g; player.y += player.v;

    // Boundary checks for player
    if (player.y < 0) { player.y = 0; player.v = 0; }
    if (player.y + player.h > canvas.height) { player.y = canvas.height - player.h; player.v = 0; }

    // Update Timers
    if (game.magnetActive) {
        game.magnetTimer--;
        if (game.magnetTimer <= 0) game.magnetActive = false;
    }

    // Spawn Obstacles
    if (game.frame % Math.max(20, 70 - game.level * 5) === 0) {
        const type = Math.random() < 0.2 + (game.level * 0.05) ? 'monster2' : 'monster1'; // More aggressive monsters in higher levels
        const size = type === 'monster2' ? 120 : 90; // Larger for aggressive
        world.obs.push({
            x: canvas.width, y: Math.random() * (canvas.height - size),
            w: size, h: size, type: type,
            speed: 7 + game.level * 1.5,
            health: type === 'monster2' ? 2 : 1 // Boss monsters might need more hits
        });
    }

    // Spawn Collectibles (Gold, Heart, Shield, Magnet)
    if (game.frame % 80 === 0) {
        const rand = Math.random();
        let type = 'coin';
        if (rand < 0.1 && game.lives < config.currentCat.lives) type = 'heart';
        else if (rand < 0.15 && !game.isShielded) type = 'shield';
        else if (rand < 0.18 && !game.magnetActive) type = 'magnet';
        
        world.items.push({ x: canvas.width, y: Math.random() * (canvas.height - 50), w: 40, h: 40, type: type });
    }

    // Update and Draw World
    drawGame();
    updateHUD();

    if (game.dist > 10000) { // Level completion distance
        endGame(true);
    } else {
        requestAnimationFrame(loop);
    }
}

function drawGame() {
    // Background (Dynamic Palace with lighting)
    ctx.fillStyle = `hsl(${(game.dist / 50) % 360}, 15%, 8%)`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Palace walls/pillars with depth effect
    ctx.fillStyle = `hsl(${(game.dist / 50) % 360}, 20%, 15%)`;
    for (let i = 0; i < 5; i++) {
        let xOffset = (i * 400 - (game.dist % 400));
        ctx.fillRect(xOffset + 50, 0, 100, canvas.height); // Pillars
    }

    // Player (Cat)
    ctx.save();
    ctx.shadowBlur = 20;
    ctx.shadowColor = game.isShielded ? varColor('shield') : varColor('cat'); // Shield glow
    ctx.drawImage(assets.cat, player.x, player.y, player.w, player.h);
    ctx.restore();

    // Obstacles
    world.obs.forEach((obj, index) => {
        obj.x -= obj.speed;
        ctx.save();
        ctx.shadowBlur = 10 + (obj.type === 'monster2' ? 15 : 0);
        ctx.shadowColor = obj.type === 'monster2' ? varColor('blood') : varColor('dark'); // Menacing glow
        ctx.drawImage(assets[obj.type], obj.x, obj.y, obj.w, obj.h);
        
        // Monster Health Bar (simple)
        if (obj.health > 1) {
            ctx.fillStyle = 'red';
            ctx.fillRect(obj.x, obj.y - 10, obj.w * (obj.health / 2), 5);
        }
        ctx.restore();

        if (checkCollision(player, obj)) {
            if (game.isShielded) {
                game.isShielded = false; // Shield used
                playSFX('hit');
                createParticles(obj.x + obj.w / 2, obj.y + obj.h / 2, 'blue');
            } else {
                game.lives--;
                playSFX('hit');
                createParticles(player.x + player.w / 2, player.y + player.h / 2, 'red');
            }
            world.obs.splice(index, 1);
            if (game.lives <= 0) endGame(false);
        }
        if (obj.x + obj.w < 0) world.obs.splice(index, 1);
    });

    // Collectibles
    world.items.forEach((obj, index) => {
        obj.x -= 5;
        if (game.magnetActive) { // Magnet effect
            let dx = player.x - obj.x;
            let dy = player.y - obj.y;
            let dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 200) { // Magnet radius
                obj.x += dx / dist * 8;
                obj.y += dy / dist * 8;
            }
        }
        
        let img = assets.coin;
        let color = 'gold';
        if (obj.type === 'heart') { img = assets.heart; color = 'red'; }
        else if (obj.type === 'shield') { img = assets.shield; color = 'blue'; }
        else if (obj.type === 'magnet') { img = assets.magnet; color = 'purple'; }
        
        ctx.drawImage(img, obj.x, obj.y, obj.w, obj.h);

        if (checkCollision(player, obj)) {
            playSFX('collect');
            createParticles(obj.x + obj.w / 2, obj.y + obj.h / 2, color);
            if (obj.type === 'coin') {
                game.score += 10;
            } else if (obj.type === 'heart' && game.lives < config.currentCat.lives) {
                game.lives++;
            } else if (obj.type === 'shield') {
                game.isShielded = true;
            } else if (obj.type === 'magnet') {
                game.magnetActive = true;
                game.magnetTimer = 300; // 5 seconds
            }
            world.items.splice(index, 1);
        }
        if (obj.x + obj.w < 0) world.items.splice(index, 1);
    });

    // Particles
    world.particles.forEach((p, index) => {
        p.x += p.vx; p.y += p.vy;
        p.life--;
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 60;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        if (p.life <= 0) world.particles.splice(index, 1);
    });
}

function checkCollision(obj1, obj2) {
    return obj1.x < obj2.x + obj2.w &&
           obj1.x + obj1.w > obj2.x &&
           obj1.y < obj2.y + obj2.h &&
           obj1.y + obj1.h > obj2.y;
}

function varColor(type) {
    if (type === 'cat') return config.currentCat.type === 3 ? '#a864c8' : '#FFD700';
    if (type === 'shield') return '#00f2ff';
    if (type === 'blood') return '#ff0000';
    if (type === 'dark') return '#000';
    return '#fff';
}

function endGame(win) {
    game.playing = false;
    playSFX(win ? 'win' : 'lose');
    
    if (win) {
        let winPrize = 50 * game.level;
        config.balance += winPrize;
        alert(`ğŸŒŸ Ù†ØµØ± Ù…Ù„ÙƒÙŠ! Ø±Ø¨Ø­Øª ${winPrize}$`);
        game.level++; // Advance to next level
    } else {
        alert("ğŸ’€ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Ø¯Ù‡Ø§Ù„ÙŠØ² Ø§Ù„Ù‚ØµØ±!");
    }
    
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('hud').style.display = 'none';
    updateHUD();
}

// Input Handling
window.onmousedown = () => { if (game.playing) { player.v = player.j; playSFX('jump'); } };
window.ontouchstart = (e) => { if (game.playing) { player.v = player.j; playSFX('jump'); } e.preventDefault(); };

// Initial setup to load assets then show menu
Promise.all(Object.values(assets).filter(a => a instanceof Image).map(img => new Promise(resolve => img.onload = resolve)))
    .then(() => {
        document.getElementById('balance').innerText = config.balance;
        updateHUD();
        // Set initial palace info for level 1
        document.getElementById('palace-info').innerHTML = `<b>Ù‚ØµØ± Ø§Ù„ØºØ¨Ø§Ø± (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${game.level})</b><br>Ø±Ø³ÙˆÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„: ${10 * game.level}$ | Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: ${50 * game.level}$`;
        document.getElementById('overlay').style.display = 'flex';
    })
    .catch(error => console.error("Error loading assets:", error));
</script>
</body>
</html>