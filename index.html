<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Himalaya Legend: Palace Escape</title>
    <style>
        :root { --gold: #FFD700; --red: #ff3131; --marble: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #1a0a00; font-family: 'Segoe UI', Tahoma, sans-serif; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        #hud { position: fixed; top: 15px; width: 100%; z-index: 1000; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        #prog-bg { width: 70%; height: 12px; background: rgba(0,0,0,0.6); border-radius: 10px; border: 2px solid var(--gold); overflow: hidden; }
        #prog-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ffa500, var(--gold)); transition: 0.1s; box-shadow: 0 0 10px var(--gold); }
        #info { display: flex; gap: 40px; color: var(--gold); font-weight: bold; font-size: 20px; margin-top: 10px; text-shadow: 2px 2px #000; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ© */
        #menu { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .palace-window { background: linear-gradient(135deg, #2c1a05, #000); padding: 40px; border-radius: 30px; border: 4px double var(--gold); text-align: center; width: 90%; max-width: 500px; box-shadow: 0 0 50px #000; }
        
        .stage-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 25px 0; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 15px; }
        .btn-stage { background: #1a1100; padding: 15px; border-radius: 12px; border: 1px solid #444; color: #666; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-stage.open { color: #fff; border-color: #888; }
        .btn-stage.active { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); transform: scale(1.05); }

        .btn-start { background: var(--gold); color: #000; width: 100%; padding: 18px; border-radius: 50px; border: none; font-size: 24px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        
        canvas { display: block; background: #000; }
    </style>
</head>
<body>

<div id="hud">
    <div id="prog-bg"><div id="prog-bar"></div></div>
    <div id="info">
        <div>ğŸ’ <span id="coins">0</span></div>
        <div>ğŸ° Ù…ØªØ¬Ø± <span id="current-stage">1</span></div>
    </div>
</div>

<div id="menu">
    <div class="palace-window">
        <h1 id="m-title" style="color:var(--gold); margin:0; font-size: 32px; text-shadow: 2px 2px #000;">Ù‡Ø±ÙˆØ¨ Ù‚ØµØ± Ø§Ù„Ù‡ÙŠÙ…Ø§Ù„Ø§ÙŠØ§</h1>
        <p id="m-desc" style="color:#ccc; margin-top:10px;">Ø§Ø¬ØªØ² Ø£Ø±ÙˆÙ‚Ø© Ø§Ù„Ù‚ØµØ± Ø§Ù„Ù…Ù„ÙƒÙŠ ÙˆØ§Ø­Ø°Ø± Ø§Ù„Ø­Ø±Ø§Ø³!</p>
        <div class="stage-grid" id="stage-grid"></div>
        <button class="btn-start" onclick="startGame()">Ø§Ù‚ØªØ­Ù… Ø§Ù„Ù‚ØµØ± ğŸ¾</button>
    </div>
</div>

<script>
const cvs = document.createElement('canvas');
const ctx = cvs.getContext('2d');
document.body.appendChild(cvs);

// Ø§Ù„Ø£ØµÙˆÙ„ (Ø§Ù„ØµÙˆØ±)
const imgCat = new Image(); imgCat.src = 'https://cdn-icons-png.flaticon.com/512/616/616408.png'; // Ù‚Ø·Ø© ØªÙ†Ø¸Ø± Ù„Ù„Ø£Ù…Ø§Ù…
const imgGold = new Image(); imgGold.src = 'https://cdn-icons-png.flaticon.com/512/2489/2489756.png';
const imgMonster = new Image(); imgMonster.src = 'https://cdn-icons-png.flaticon.com/512/1211/1211053.png'; // ÙˆØ¬Ù‡ ÙˆØ­Ø´
const imgGem = new Image(); imgGem.src = 'https://cdn-icons-png.flaticon.com/512/616/616430.png';

let game = { playing: false, stage: 1, unlocked: 1, score: 0, dist: 0, frame: 0, portal: -1 };
let player = { x: 0, y: 0, v: 0, g: 0.5, j: -10, w: 80, h: 80 };
let objects = { obs: [], gold: [], gems: [] };

function sfx(f, t, d) {
    const audio = new (window.AudioContext || window.webkitAudioContext)();
    let o = audio.createOscillator(), g = audio.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
    o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime + d);
}

function resize() {
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    player.x = cvs.width * 0.15;
}
window.onresize = resize; resize();

function buildMenu() {
    const grid = document.getElementById('stage-grid'); grid.innerHTML = '';
    for(let i=1; i<=20; i++) {
        const b = document.createElement('div');
        let status = i <= game.unlocked ? 'open' : 'locked';
        b.className = `btn-stage ${status} ${i==game.stage?'active':''}`;
        b.innerHTML = i <= game.unlocked ? `Ù…ØªØ¬Ø± ${i}` : `ğŸ”’`;
        if(status === 'open') b.onclick = () => { game.stage = i; buildMenu(); sfx(400,'sine',0.1); };
        grid.appendChild(b);
    }
}
buildMenu();

function startGame() {
    game.playing = true; game.dist = 0; game.frame = 0; game.portal = -1;
    objects = { obs: [], gold: [], gems: [] };
    player.y = cvs.height/2; player.v = 0;
    document.getElementById('menu').style.display = 'none';
    sfx(200, 'square', 0.4);
    update();
}

function drawPalace() {
    // Ø§Ù„Ø£Ø±Ø¶ÙŠØ© ÙˆØ§Ù„Ø³Ù‚Ù (Ø±Ø®Ø§Ù…)
    ctx.fillStyle = '#0a0500'; ctx.fillRect(0,0,cvs.width, cvs.height);
    
    // Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù‚ØµØ± ÙˆØ§Ù„Ù†ÙˆØ§ÙØ°
    ctx.fillStyle = '#1a1105';
    for(let i=0; i<6; i++) {
        let xPos = (i * 300 - (game.dist % 300));
        // Ø§Ù„Ù†Ø§ÙØ°Ø©
        ctx.fillStyle = '#2d1a0a';
        ctx.beginPath();
        ctx.arc(xPos + 100, 200, 50, Math.PI, 0);
        ctx.fillRect(xPos + 50, 200, 100, 150);
        ctx.fill();
        // Ø§Ù„Ø¹Ù…ÙˆØ¯
        ctx.fillStyle = '#3d2b1a';
        ctx.fillRect(xPos, 0, 40, cvs.height);
    }
}

function update() {
    if(!game.playing) return;
    game.frame++;
    if(game.portal === -1) game.dist += 2.5;

    let target = 3000;
    let progress = Math.min(100, (game.dist / target) * 100);
    document.getElementById('prog-bar').style.width = progress + '%';
    document.getElementById('coins').innerText = game.score;
    document.getElementById('current-stage').innerText = game.stage;

    drawPalace();

    // Ø§Ù„Ù‚Ø·Ø© (ØªÙˆØ§Ø¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
    player.v += player.g; player.y += player.v;
    ctx.drawImage(imgCat, player.x, player.y, player.w, player.h);

    // Ø§Ù„Ø°Ù‡Ø¨
    if(game.frame % 80 == 0 && game.portal === -1) objects.gold.push({x: cvs.width, y: 150 + Math.random()*(cvs.height-300)});
    objects.gold.forEach((g, i) => {
        g.x -= 7; ctx.drawImage(imgGold, g.x, g.y, 40, 40);
        if(Math.hypot(player.x + 40 - g.x, player.y + 40 - g.y) < 50) {
            objects.gold.splice(i,1); game.score += 5; sfx(900, 'sine', 0.1);
        }
    });

    // Ø§Ù„ÙˆØ­ÙˆØ´ (ÙˆØ¬ÙˆÙ‡ Ù…Ø±Ø¹Ø¨Ø©)
    if(game.frame % Math.max(20, 80 - game.stage*3) == 0 && game.portal === -1) {
        objects.obs.push({x: cvs.width, y: 100 + Math.random()*(cvs.height-200), s: 80});
    }
    objects.obs.forEach((o, i) => {
        o.x -= (8 + game.stage*0.5);
        ctx.drawImage(imgMonster, o.x, o.y, o.s, o.s);
        // Ø§ØµØ·Ø¯Ø§Ù… Ù‚Ø§ØªÙ„
        if(player.x+15 < o.x+o.s-15 && player.x+player.w-15 > o.x+15 && player.y+15 < o.y+o.s-15 && player.y+player.h-15 > o.y+15) {
            die();
        }
    });

    // Ø³Ù‚Ù ÙˆØ£Ø±Ø¶ÙŠØ© Ø§Ù„Ù‚ØµØ±
    if(player.y < 50 || player.y > cvs.height - 130) die();

    // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©
    if(progress >= 100 && game.portal === -1) game.portal = cvs.width;
    if(game.portal > -1) {
        game.portal -= 6;
        ctx.strokeStyle = varColor(); ctx.lineWidth = 15;
        ctx.strokeRect(game.portal, 100, 80, cvs.height - 200);
        if(player.x > game.portal) win();
    }

    requestAnimationFrame(update);
}

function varColor() { return game.stage === 20 ? '#ff00ea' : '#FFD700'; }

function die() {
    game.playing = false;
    sfx(80, 'sawtooth', 0.5);
    document.getElementById('m-title').innerText = "Ø£Ù…Ø³Ùƒ Ø¨Ùƒ Ø§Ù„Ø­Ø±Ø§Ø³!";
    document.getElementById('m-desc').innerText = "Ù„Ù‚Ø¯ ÙØ´Ù„Øª ÙÙŠ Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ù‚ØµØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
    buildMenu();
    document.getElementById('menu').style.display = 'flex';
}

function win() {
    game.playing = false;
    sfx(1000, 'square', 0.5);
    if(game.stage === game.unlocked) game.unlocked++;
    document.getElementById('m-title').innerText = "Ù‡Ø±ÙˆØ¨ Ù†Ø§Ø¬Ø­!";
    document.getElementById('m-desc').innerText = `Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø§Ø¬ØªØ²Øª Ø§Ù„Ù‚ØµØ± Ø§Ù„Ù…Ù„ÙƒÙŠ ${game.stage}.`;
    if(game.stage < 20) game.stage++;
    buildMenu();
    document.getElementById('menu').style.display = 'flex';
}

const jump = (e) => { if(game.playing) { player.v = player.j; sfx(600, 'triangle', 0.08); } if(e) e.preventDefault(); };
window.onmousedown = jump; window.ontouchstart = jump;
</script>
</body>
</html>